<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Cashflow –≥—Ä–∞—Ñ—ñ–∫–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1f2937;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            position: relative;
            height: 300px;
            background: #374151;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #2563eb;
        }
        .info {
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Cashflow –≥—Ä–∞—Ñ—ñ–∫–∞</h1>
        
        <div class="info">
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
            <p><strong>–ü–æ—Ç–æ—á–Ω–∞ –≤–∞–ª—é—Ç–∞:</strong> <span id="currentCurrency">UAH</span></p>
            <p><strong>–ü–æ—Ç–æ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥:</strong> <span id="currentPeriod">6m</span></p>
        </div>

        <div class="controls">
            <strong>–ü–µ—Ä—ñ–æ–¥:</strong>
            <button onclick="loadData('7d')">7 –¥–Ω—ñ–≤</button>
            <button onclick="loadData('14d')">14 –¥–Ω—ñ–≤</button>
            <button onclick="loadData('30d')">30 –¥–Ω—ñ–≤</button>
            <button onclick="loadData('3m')">3 –º—ñ—Å—è—Ü—ñ</button>
            <button onclick="loadData('6m')">6 –º—ñ—Å—è—Ü—ñ–≤</button>
        </div>

        <div class="controls">
            <strong>–í–∞–ª—é—Ç–∞:</strong>
            <button onclick="changeCurrency('UAH')">‚Ç¥ UAH</button>
            <button onclick="changeCurrency('USD')">$ USD</button>
            <button onclick="changeCurrency('PLN')">z≈Ç PLN</button>
        </div>

        <div class="chart-container">
            <canvas id="cashflowChart"></canvas>
        </div>

        <div class="info">
            <h3>–î–∞–Ω—ñ –≥—Ä–∞—Ñ—ñ–∫–∞:</h3>
            <pre id="chartData" style="overflow-x: auto;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</pre>
        </div>

        <div class="info">
            <h3>Console Log:</h3>
            <pre id="consoleLog" style="overflow-x: auto; max-height: 200px;"></pre>
        </div>
    </div>

    <script>
        let chart = null;
        let currentPeriod = '6m';
        let currentCurrency = 'UAH';

        // Override console.log to display in page
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.getElementById('consoleLog');
            logDiv.textContent += args.join(' ') + '\n';
        };

        const currencySymbols = {
            'UAH': '‚Ç¥',
            'USD': '$',
            'PLN': 'z≈Ç',
            'EUR': '‚Ç¨'
        };

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function changeCurrency(currency) {
            currentCurrency = currency;
            document.getElementById('currentCurrency').textContent = currency;
            loadData(currentPeriod, currency);
        }

        function loadData(period, currency = null) {
            if (!currency) currency = currentCurrency;
            
            currentPeriod = period;
            document.getElementById('currentPeriod').textContent = period;
            
            updateStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...');
            console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: period=${period}, currency=${currency}`);

            const url = `/api/v1/stats/cashflow?period=${period}&currency=${currency}`;
            
            fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:', data);
                
                if (!data.success) {
                    throw new Error('API returned success=false');
                }

                const cashflow = data.data.cashflow;
                const currency = data.data.currency;
                
                // Display raw data
                document.getElementById('chartData').textContent = JSON.stringify(data, null, 2);
                
                updateStatus('–î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ú–∞–ª—é—é –≥—Ä–∞—Ñ—ñ–∫...');
                drawChart(cashflow, currency);
                updateStatus('‚úÖ –ì—Ä–∞—Ñ—ñ–∫ –≥–æ—Ç–æ–≤–∏–π!');
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                updateStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            });
        }

        function drawChart(cashflow, currency) {
            const ctx = document.getElementById('cashflowChart');
            const symbol = currencySymbols[currency] || currency;

            console.log('–ú–∞–ª—é—é –≥—Ä–∞—Ñ—ñ–∫ –∑', cashflow.length, '—Ç–æ—á–∫–∞–º–∏ –¥–∞–Ω–∏—Ö');

            // Destroy old chart
            if (chart) {
                console.log('–ó–Ω–∏—â—É—é —Å—Ç–∞—Ä–∏–π –≥—Ä–∞—Ñ—ñ–∫');
                chart.destroy();
                chart = null;
            }

            // Create new chart
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: cashflow.map(item => item.period),
                    datasets: [
                        {
                            label: '–î–æ—Ö–æ–¥–∏',
                            data: cashflow.map(item => item.income),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '–í–∏—Ç—Ä–∞—Ç–∏',
                            data: cashflow.map(item => item.expense),
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Cashflow (${symbol})`,
                            color: '#f9fafb',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            labels: {
                                color: '#f9fafb',
                                font: { size: 14 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grace: '5%',
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return value.toLocaleString('uk-UA') + ' ' + symbol;
                                }
                            },
                            grid: { color: '#4b5563' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#4b5563' }
                        }
                    }
                }
            });

            console.log('–ì—Ä–∞—Ñ—ñ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
        }

        // Initial load
        console.log('–ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
        loadData('6m', 'UAH');
    </script>
</body>
</html>
